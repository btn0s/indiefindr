name: Sync Supabase Preview Branch Credentials to Vercel

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  sync-preview-env:
    runs-on: ubuntu-latest
    # Skip if PR is closed (cleanup happens in separate job)
    if: github.event.action != 'closed'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Authenticate Supabase CLI
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "⚠️ SUPABASE_ACCESS_TOKEN secret not set. Please add it to GitHub secrets."
            echo "Get token from: Supabase Dashboard → Account → Access Tokens"
            exit 1
          fi
          # The CLI will use SUPABASE_ACCESS_TOKEN from env automatically
          echo "✓ Supabase CLI authenticated via SUPABASE_ACCESS_TOKEN"

      - name: Wait for preview branch creation
        id: wait-branch
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          echo "Waiting for Supabase preview branch '$BRANCH_NAME' to be created..."
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            OUTPUT=$(supabase branches get "$BRANCH_NAME" \
              --project-ref "$SUPABASE_PROJECT_REF" \
              --experimental \
              --output json 2>&1) || true
            
            if echo "$OUTPUT" | grep -q '"status"\|"id"'; then
              echo "✓ Branch found!"
              echo "branch_exists=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - branch not ready yet, waiting 10s..."
            sleep 10
          done
          
          echo "⚠ Branch not found after $MAX_ATTEMPTS attempts"
          echo "branch_exists=false" >> $GITHUB_OUTPUT
          exit 0

      - name: Set preview branch credentials
        if: steps.wait-branch.outputs.branch_exists == 'true'
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          
          # Construct branch-specific API URL
          # Format: https://<project-ref>-<branch-name>.supabase.co
          SUPABASE_URL="https://${SUPABASE_PROJECT_REF}-${BRANCH_NAME}.supabase.co"
          
          echo "SUPABASE_URL=$SUPABASE_URL" >> $GITHUB_ENV
          echo "SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY" >> $GITHUB_ENV
          echo "SUPABASE_SERVICE_KEY=$SUPABASE_SERVICE_ROLE_KEY" >> $GITHUB_ENV
          
          echo "✓ Configured credentials for branch: $BRANCH_NAME"
          echo "  API URL: $SUPABASE_URL"

      - name: Install Vercel CLI
        if: steps.wait-branch.outputs.branch_exists == 'true'
        run: |
          npm install -g vercel@latest

      - name: Set Vercel branch-scoped environment variables
        if: steps.wait-branch.outputs.branch_exists == 'true'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          BRANCH_NAME: ${{ github.head_ref }}
        run: |
          # Set branch-scoped Preview environment variables
          # These override the default Preview env vars for this specific branch
          vercel env add NEXT_PUBLIC_SUPABASE_URL preview \
            "$SUPABASE_URL" \
            --token="$VERCEL_TOKEN" \
            --scope="$VERCEL_ORG_ID" \
            --yes \
            --branch="$BRANCH_NAME" || echo "Failed to set NEXT_PUBLIC_SUPABASE_URL (may already exist)"
          
          vercel env add NEXT_PUBLIC_SUPABASE_ANON_KEY preview \
            "$SUPABASE_ANON_KEY" \
            --token="$VERCEL_TOKEN" \
            --scope="$VERCEL_ORG_ID" \
            --yes \
            --branch="$BRANCH_NAME" || echo "Failed to set NEXT_PUBLIC_SUPABASE_ANON_KEY (may already exist)"
          
          vercel env add SUPABASE_SERVICE_ROLE_KEY preview \
            "$SUPABASE_SERVICE_KEY" \
            --token="$VERCEL_TOKEN" \
            --scope="$VERCEL_ORG_ID" \
            --yes \
            --branch="$BRANCH_NAME" || echo "Failed to set SUPABASE_SERVICE_ROLE_KEY (may already exist)"
          
          echo "✓ Set branch-scoped environment variables for branch: $BRANCH_NAME"

  cleanup-preview-env:
    runs-on: ubuntu-latest
    # Only run when PR is closed
    if: github.event.action == 'closed'
    
    steps:
      - name: Install Vercel CLI
        run: |
          npm install -g vercel@latest

      - name: Remove Vercel branch-scoped environment variables
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          BRANCH_NAME: ${{ github.head_ref }}
        run: |
          # Remove branch-scoped env vars (Supabase will delete the branch automatically)
          vercel env rm NEXT_PUBLIC_SUPABASE_URL preview \
            --token="$VERCEL_TOKEN" \
            --scope="$VERCEL_ORG_ID" \
            --yes \
            --branch="$BRANCH_NAME" || echo "Env var not found or already removed"
          
          vercel env rm NEXT_PUBLIC_SUPABASE_ANON_KEY preview \
            --token="$VERCEL_TOKEN" \
            --scope="$VERCEL_ORG_ID" \
            --yes \
            --branch="$BRANCH_NAME" || echo "Env var not found or already removed"
          
          vercel env rm SUPABASE_SERVICE_ROLE_KEY preview \
            --token="$VERCEL_TOKEN" \
            --scope="$VERCEL_ORG_ID" \
            --yes \
            --branch="$BRANCH_NAME" || echo "Env var not found or already removed"
          
          echo "✓ Removed branch-scoped environment variables for branch: $BRANCH_NAME"
